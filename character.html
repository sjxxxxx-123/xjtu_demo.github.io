<!-- author: sjxxxx -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建角色 - XJTU本科模拟器</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 角色创建界面 -->
    <div id="character-screen" class="screen active">
        <div class="character-container">
            <h2>创建你的角色</h2>
            
            <!-- 出身背景选择 -->
            <div class="selection-section">
                <h3>选择出身背景</h3>
                <div class="option-grid" id="background-options">
                    <!-- JS动态生成 -->
                </div>
            </div>

            <!-- 书院选择 -->
            <div class="selection-section">
                <h3>选择书院</h3>
                <div class="option-grid" id="college-options">
                   <!-- JS动态生成 -->
                </div>
            </div>

            <!-- 选中详情展示 -->
            <div id="selection-details" class="selection-details" style="display: none;">
                <h3 id="detail-title">详细信息</h3>
                <div id="detail-content">请选择背景和书院查看详情</div>
            </div>

            <div class="character-actions">
                <button id="btn-back-start" class="btn btn-secondary">返回</button>
                <button id="btn-start-game" class="btn btn-primary" disabled>确认开始</button>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script>
        let selectedBackground = null;
        let selectedCollege = null;

        function renderOptions() {
            // Render Backgrounds
            const bgContainer = document.getElementById('background-options');
            bgContainer.innerHTML = '';
            
            if (typeof GameData !== 'undefined' && GameData.backgrounds) {
                Object.values(GameData.backgrounds).forEach(bg => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.dataset.value = bg.id;
                    card.innerHTML = `
                        <div class="option-icon">${bg.icon}</div>
                        <div class="option-name">${bg.name}</div>
                        <div class="option-desc">${bg.description}</div>
                    `;
                    bgContainer.appendChild(card);
                });
            } else {
                console.error('GameData.backgrounds not found');
            }

            // Render Colleges
            const collegeContainer = document.getElementById('college-options');
            collegeContainer.innerHTML = '';

            if (typeof GameData !== 'undefined' && GameData.colleges) {
                Object.values(GameData.colleges).forEach(college => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.dataset.value = college.id;

                    // 简化版标签生成
                    let miniTags = '';
                    if (college.buffs) {
                        miniTags += college.buffs.map(b => `<span class="mini-tag buff">${b.name}</span>`).join('');
                    }
                    if (college.debuffs) {
                        miniTags += college.debuffs.map(db => `<span class="mini-tag debuff">${db.name}</span>`).join('');
                    }

                    // description is the "narration"/"flavor text"
                    card.innerHTML = `
                        <div class="option-icon">${college.icon}</div>
                        <div class="option-name">${college.name}</div>
                        <div class="option-desc">
                            <div style="margin-bottom:8px; font-weight:500; color:#444; font-size:0.9em; font-style:italic;">${college.description}</div>
                            <div class="mini-tags">${miniTags}</div>
                        </div>
                    `;
                    collegeContainer.appendChild(card);
                });
            } else {
                console.error('GameData.colleges not found');
            }
        }

        function updateDetailPanel() {
            const container = document.getElementById('selection-details');
            const titleEl = document.getElementById('detail-title');
            const contentEl = document.getElementById('detail-content');

            if (!selectedBackground && !selectedCollege) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            let html = '';

            // 背景详情
            if (selectedBackground) {
                const bg = GameData.backgrounds[selectedBackground];
                html += `
                    <div class="detail-group">
                        <span class="detail-label">【出身背景】${bg.name}</span>
                        <div class="detail-item">${bg.description}</div>
                    </div>
                `;
            }

            // 书院详情
            if (selectedCollege) {
                const col = GameData.colleges[selectedCollege];
                html += `<div class="detail-group"><span class="detail-label">【所属书院】${col.name}</span>`;
                
                // Buffs
                if (col.buffs && col.buffs.length > 0) {
                    col.buffs.forEach(b => {
                        html += `
                            <div class="detail-item">
                                <span class="detail-tag buff">${b.name}</span>
                                <span>${b.desc}</span>
                            </div>
                        `;
                    });
                }

                // Debuffs
                if (col.debuffs && col.debuffs.length > 0) {
                    col.debuffs.forEach(db => {
                        html += `
                            <div class="detail-item">
                                <span class="detail-tag debuff">${db.name}</span>
                                <span>${db.desc}</span>
                            </div>
                        `;
                    });
                }
                html += `</div>`;
            }

            contentEl.innerHTML = html;
        }

        function initSelection() {
             // Background Selection Delegation
             document.getElementById('background-options').addEventListener('click', function(e) {
                const card = e.target.closest('.option-card');
                if (!card) return;
                
                document.querySelectorAll('#background-options .option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedBackground = card.dataset.value;
                checkCanStart();
                updateDetailPanel();
            });

            // College Selection Delegation
            document.getElementById('college-options').addEventListener('click', function(e) {
                const card = e.target.closest('.option-card');
                if (!card) return;

                document.querySelectorAll('#college-options .option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedCollege = card.dataset.value;
                checkCanStart();
                updateDetailPanel();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            renderOptions();
            initSelection();

            // 返回按钮
            document.getElementById('btn-back-start').addEventListener('click', function() {
                window.location.href = 'index.html';
            });

            // 确认开始
            document.getElementById('btn-start-game').addEventListener('click', function() {
                if (selectedBackground && selectedCollege) {
                    // 保存选择到localStorage
                    localStorage.setItem('xjtu_character', JSON.stringify({
                        background: selectedBackground,
                        college: selectedCollege
                    }));
                    sessionStorage.setItem('valid_session', 'true');
                    localStorage.setItem('xjtu_session_token', 'true'); // 手机端兼容性备份
                    window.location.href = 'game.html';
                }
            });
        });

        function checkCanStart() {
            const canStart = selectedBackground && selectedCollege;
            document.getElementById('btn-start-game').disabled = !canStart;
        }
    </script>
</body>
</html>

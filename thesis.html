<!-- author: sjxxxx -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>æ¯•ä¸šè®¾è®¡ - é²œæ¤’æœ¬ç§‘æ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- å¤§å››æ¯•è®¾ç•Œé¢ -->
    <div id="thesis-screen" class="screen active">
        <header class="game-header">
            <div class="time-info">
                <span id="thesis-year">å¤§å››</span>
                <span id="thesis-month">9æœˆ</span>
            </div>
            <div class="location-info">
                <span>ğŸ—ï¸ åˆ›æ–°æ¸¯æ ¡åŒº</span>
            </div>
            <button id="btn-thesis-menu" class="btn-icon">â˜°</button>
        </header>

        <div class="thesis-container">
            <h2>ğŸ“ æ¯•ä¸šè®¾è®¡æ¨¡å¼</h2>
            <div class="thesis-progress">
                <div class="progress-label">æ¯•è®¾è¿›åº¦</div>
                <div class="progress-bar-large">
                    <div class="progress-fill" id="thesis-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-value" id="thesis-progress-value">0%</div>
            </div>

            <div class="thesis-stats">
                <div class="thesis-stat">
                    <span>SANå€¼</span>
                    <span id="thesis-san">80/100</span>
                </div>
                <div class="thesis-stat">
                    <span>é‡‘å¸</span>
                    <span id="thesis-money">ğŸ’° 1000</span>
                </div>
            </div>

            <div class="thesis-actions">
                <button class="action-btn study" data-action="thesis-work">
                    <span class="action-icon">ğŸ’»</span>
                    <span class="action-name">åšæ¯•è®¾</span>
                    <span class="action-cost">è¿›åº¦+10%, SAN-5</span>
                </button>
                <button class="action-btn study" data-action="thesis-meeting">
                    <span class="action-icon">ğŸ‘¨â€ğŸ«</span>
                    <span class="action-name">è§å¯¼å¸ˆ</span>
                    <span class="action-cost">è¿›åº¦+5%, SAN-3</span>
                </button>
                <button class="action-btn life" data-action="thesis-rest">
                    <span class="action-icon">â˜•</span>
                    <span class="action-name">ä¼‘æ¯æ”¾æ¾</span>
                    <span class="action-cost">é‡‘å¸-50, SAN+10</span>
                </button>
                <button class="action-btn special" data-action="thesis-city">
                    <span class="action-icon">ğŸšŒ</span>
                    <span class="action-name">è¿›åŸ</span>
                    <span class="action-cost">é‡‘å¸-80, SAN+15</span>
                </button>
            </div>

            <div class="thesis-warning" id="thesis-warning">
                <p>âš ï¸ ã€äºŒæ¬¡è¥¿è¿ã€‘åˆ›æ–°æ¸¯è·ç¦»å¸‚åŒºè¾ƒè¿œï¼Œè¿›åŸæ¶ˆè€—å¢åŠ ï¼</p>
            </div>

            <!-- ä¸‹ä¸€å›åˆæŒ‰é’® -->
            <div class="turn-control">
                <button id="btn-thesis-next" class="btn btn-primary btn-large">
                    ç»“æŸæœ¬æœˆ â–¶
                </button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨Modalå¼¹çª— -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">æç¤º</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-primary" id="modal-confirm">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆèœå• -->
    <div id="game-menu" class="modal">
        <div class="modal-content menu-content">
            <h3>æ¸¸æˆèœå•</h3>
            <div class="menu-buttons">
                <button id="btn-save" class="btn btn-secondary">ğŸ’¾ ä¿å­˜æ¸¸æˆ</button>
                <button id="btn-view-achievements" class="btn btn-secondary">ğŸ† æŸ¥çœ‹æˆå°±</button>
                <button id="btn-quit" class="btn btn-danger">ğŸšª é€€å‡ºæ¸¸æˆ</button>
            </div>
            <button id="btn-close-menu" class="btn btn-primary">ç»§ç»­æ¸¸æˆ</button>
        </div>
    </div>

    <!-- æˆå°±è§£é”å¼¹çª— -->
    <div id="achievement-popup" class="achievement-popup">
        <div class="achievement-popup-content">
            <div class="achievement-icon">ğŸ†</div>
            <div class="achievement-text">
                <span class="achievement-label">æˆå°±è§£é”ï¼</span>
                <span class="achievement-name" id="achievement-name"></span>
            </div>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/achievements.js"></script>
    <script src="js/events.js"></script>
    <script>
        // æ¯•è®¾æ¨¡å¼æ¸¸æˆé€»è¾‘
        class ThesisMode {
            constructor() {
                this.state = null;
                this.loadState();
                this.bindEvents();
                this.updateUI();
            }

            loadState() {
                const saved = localStorage.getItem('xjtu_game_state');
                if (saved) {
                    this.state = JSON.parse(saved);
                } else {
                    window.location.href = 'index.html';
                    return;
                }
                
                // åˆå§‹åŒ–æ¯•è®¾çŠ¶æ€
                if (!this.state.thesisProgress) {
                    this.state.thesisProgress = 0;
                }
            }

            saveState() {
                localStorage.setItem('xjtu_game_state', JSON.stringify(this.state));
            }

            bindEvents() {
                // è¡ŒåŠ¨æŒ‰é’®
                document.querySelectorAll('.thesis-actions .action-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.doAction(btn.dataset.action));
                });

                // ä¸‹ä¸€å›åˆ
                document.getElementById('btn-thesis-next').addEventListener('click', () => this.nextTurn());

                // èœå•
                document.getElementById('btn-thesis-menu').addEventListener('click', () => {
                    document.getElementById('game-menu').classList.add('active');
                });
                document.getElementById('btn-close-menu').addEventListener('click', () => {
                    document.getElementById('game-menu').classList.remove('active');
                });
                document.getElementById('btn-save').addEventListener('click', () => {
                    this.saveState();
                    this.showMessage('ä¿å­˜æˆåŠŸ', 'æ¸¸æˆå·²ä¿å­˜ï¼');
                });
                document.getElementById('btn-view-achievements').addEventListener('click', () => {
                    window.location.href = 'achievements.html?from=thesis';
                });
                document.getElementById('btn-quit').addEventListener('click', () => {
                    window.location.href = 'index.html';
                });

                // Modal
                document.getElementById('modal-close').addEventListener('click', () => this.hideModal());
                document.getElementById('modal-confirm').addEventListener('click', () => this.hideModal());
            }

            doAction(action) {
                switch(action) {
                    case 'thesis-work':
                        this.state.thesisProgress = Math.min(100, this.state.thesisProgress + 10);
                        this.state.san = Math.max(0, this.state.san - 5);
                        break;
                    case 'thesis-meeting':
                        this.state.thesisProgress = Math.min(100, this.state.thesisProgress + 5);
                        this.state.san = Math.max(0, this.state.san - 3);
                        break;
                    case 'thesis-rest':
                        this.state.money -= 50;
                        this.state.san = Math.min(100, this.state.san + 10);
                        break;
                    case 'thesis-city':
                        this.state.money -= 80;
                        this.state.san = Math.min(100, this.state.san + 15);
                        AchievementSystem.unlock('secondWestward');
                        break;
                }
                this.updateUI();
            }

            nextTurn() {
                this.state.month++;
                if (this.state.month > 12) {
                    this.state.month = 1;
                }

                // æ£€æŸ¥æ¯•ä¸š
                if (this.state.month === 6 && this.state.year === 4) {
                    this.checkGraduation();
                    return;
                }

                // æ£€æŸ¥SANå€¼
                if (this.state.san <= 0) {
                    this.showMessage('ç²¾ç¥å´©æºƒ', 'ä½ çš„ç²¾ç¥çŠ¶æ€å´©æºƒäº†...', () => {
                        window.location.href = 'ending.html?type=dropout';
                    });
                    return;
                }

                this.saveState();
                this.updateUI();
            }

            checkGraduation() {
                if (this.state.thesisProgress >= 100) {
                    // æ ¹æ®GPAå†³å®šç»“å±€
                    let endingType = 'normal';
                    if (this.state.gpa >= 3.8) {
                        endingType = 'excellent';
                    } else if (this.state.gpa >= 3.2) {
                        endingType = 'postgraduate';
                    }
                    window.location.href = 'ending.html?type=' + endingType;
                } else {
                    this.showMessage('æ¯•è®¾æœªå®Œæˆ', 'ä½ çš„æ¯•è®¾è¿›åº¦ä¸è¶³ï¼Œæ— æ³•æ¯•ä¸š...', () => {
                        window.location.href = 'ending.html?type=dropout';
                    });
                }
            }

            updateUI() {
                document.getElementById('thesis-month').textContent = this.state.month + 'æœˆ';
                document.getElementById('thesis-san').textContent = this.state.san + '/100';
                document.getElementById('thesis-money').textContent = 'ğŸ’° ' + this.state.money;
                document.getElementById('thesis-progress-bar').style.width = this.state.thesisProgress + '%';
                document.getElementById('thesis-progress-value').textContent = this.state.thesisProgress + '%';
            }

            showMessage(title, content, callback) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = '<p>' + content + '</p>';
                document.getElementById('modal').classList.add('active');
                if (callback) {
                    document.getElementById('modal-confirm').onclick = callback;
                }
            }

            hideModal() {
                document.getElementById('modal').classList.remove('active');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            new ThesisMode();
        });
    </script>
</body>
</html>

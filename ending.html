<!-- author: sjxxxx -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»“å±€ - é²œæ¤’æœ¬ç§‘æ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="css/style.css">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ç»“å±€ç•Œé¢ -->
    <div id="ending-screen" class="screen active">
        <div class="ending-container">
            <div class="ending-icon" id="ending-icon">ğŸ“</div>
            <h2 class="ending-title" id="ending-title">æ¯•ä¸šäº†ï¼</h2>
            <p class="ending-desc" id="ending-desc">æ­å–œä½ å®Œæˆäº†å››å¹´çš„å¤§å­¦ç”Ÿæ´»</p>
            <div class="ending-stats" id="ending-stats">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="ending-achievements" id="ending-achievements">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="ending-biography" id="ending-biography">
                <div class="biography-loading">æ­£åœ¨ç”Ÿæˆå°ä¼ ...</div>
            </div>
            <div class="ending-actions">
                <button id="btn-restart" class="btn btn-primary">é‡æ–°å¼€å§‹</button>
                <button id="btn-view-achievements" class="btn btn-secondary">æŸ¥çœ‹æˆå°±</button>
            </div>
        </div>
    </div>

    <script src="js/ai_module.js"></script>
    <script src="js/achievements.js"></script>
    <script>
        const endings = {
            dropout: {
                icon: 'ğŸ˜¢',
                title: 'è‚„ä¸šç»“å±€',
                desc: 'å¾ˆé—æ†¾ï¼Œä½ æ²¡èƒ½å®Œæˆå­¦ä¸šã€‚ä½†è¿™ä¸æ˜¯ç»“æŸï¼Œäººç”Ÿè¿˜æœ‰å¾ˆå¤šå¯èƒ½æ€§...',
                color: '#f44336'
            },
            normal: {
                icon: 'ğŸ“',
                title: 'æ™®é€šæ¯•ä¸š',
                desc: 'ä½ é¡ºåˆ©å®Œæˆäº†å››å¹´å¤§å­¦ç”Ÿæ´»ï¼Œæ‹¿åˆ°äº†æ¯•ä¸šè¯ã€‚å¹³å‡¡è€Œçè´µçš„é’æ˜¥ã€‚',
                color: '#4CAF50'
            },
            postgraduate: {
                icon: 'ğŸ“š',
                title: 'ä¿ç ”æˆåŠŸ',
                desc: 'ä¼˜å¼‚çš„æˆç»©è®©ä½ è·å¾—äº†ä¿ç ”èµ„æ ¼ï¼Œç»§ç»­åœ¨å­¦æœ¯é“è·¯ä¸Šå‰è¿›ï¼',
                color: '#2196F3'
            },
            excellent: {
                icon: 'ğŸ†',
                title: 'ä¼˜ç§€æ¯•ä¸šç”Ÿ',
                desc: 'ä½ æ˜¯å¹´çº§çš„ä½¼ä½¼è€…ï¼Œè·å¾—äº†ä¼˜ç§€æ¯•ä¸šç”Ÿç§°å·ï¼Œå‰é€”æ— é‡ï¼',
                color: '#FF9800'
            },
            westward: {
                icon: 'ğŸš€',
                title: 'è¥¿è¿ç²¾ç¥ä¼ æ‰¿è€…',
                desc: 'ä½ æ·±åˆ»ç†è§£äº†è¥¿è¿ç²¾ç¥ï¼Œé€‰æ‹©å»è¥¿éƒ¨å»ºè®¾ç¥–å›½ï¼Œæˆä¸ºæ–°æ—¶ä»£çš„è¥¿è¿äººï¼',
                color: '#9C27B0'
            }
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // è·å–ç»“å±€ç±»å‹
            const urlParams = new URLSearchParams(window.location.search);
            const endingType = urlParams.get('type') || 'normal';
            const ending = endings[endingType] || endings.normal;

            // æ›´æ–°ç•Œé¢
            document.getElementById('ending-icon').textContent = ending.icon;
            document.getElementById('ending-title').textContent = ending.title;
            document.getElementById('ending-title').style.color = ending.color;
            document.getElementById('ending-desc').textContent = ending.desc;

            // è·å–æ¸¸æˆçŠ¶æ€æ˜¾ç¤ºç»Ÿè®¡
            const savedState = localStorage.getItem('xjtu_game_state');
            let parsedState = null;
            if (savedState) {
                const state = JSON.parse(savedState);
                parsedState = state;
                const statsDiv = document.getElementById('ending-stats');
                statsDiv.innerHTML = `
                    <div class="ending-stat-item">
                        <span class="stat-label">æœ€ç»ˆGPA</span>
                        <span class="stat-value">${state.gpa ? state.gpa.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="ending-stat-item">
                        <span class="stat-label">ç»¼æµ‹åˆ†æ•°</span>
                        <span class="stat-value">${state.social || 0}</span>
                    </div>
                    <div class="ending-stat-item">
                        <span class="stat-label">æŒ‚ç§‘æ¬¡æ•°</span>
                        <span class="stat-value">${state.failedCourses || 0}</span>
                    </div>
                    <div class="ending-stat-item">
                        <span class="stat-label">å‰©ä½™é‡‘å¸</span>
                        <span class="stat-value">ğŸ’° ${state.money || 0}</span>
                    </div>
                `;
            }

            // æ˜¾ç¤ºè§£é”çš„æˆå°±
            const achievementList = AchievementSystem.getAchievementList();
            const unlockedAchievements = achievementList.filter(a => a.unlocked);
            const achievementsDiv = document.getElementById('ending-achievements');
            
            if (unlockedAchievements.length > 0) {
                achievementsDiv.innerHTML = `
                    <h3>ğŸ† æœ¬æ¬¡è§£é”æˆå°± (${unlockedAchievements.length}/${achievementList.length})</h3>
                    <div class="ending-achievements-list">
                        ${unlockedAchievements.slice(0, 6).map(a => `
                            <div class="ending-achievement-item">
                                <span class="icon">${a.icon}</span>
                                <span class="name">${a.name}</span>
                            </div>
                        `).join('')}
                        ${unlockedAchievements.length > 6 ? `<div class="ending-achievement-more">è¿˜æœ‰ ${unlockedAchievements.length - 6} ä¸ª...</div>` : ''}
                    </div>
                `;
            }

            const biographyTarget = document.getElementById('ending-biography');
            const renderBiography = (bio) => {
                biographyTarget.innerHTML = '';

                const title = document.createElement('div');
                title.className = 'biography-title';
                title.textContent = bio.title || 'ç»“å±€å°ä¼ ';

                const quote = document.createElement('div');
                quote.className = 'biography-quote';
                quote.textContent = bio.quote || 'â€œçŸ¥æ­¢ä¸æ®†ï¼Œå–„è«å¤§ç„‰ã€‚â€';

                const dividerTop = document.createElement('div');
                dividerTop.className = 'biography-divider';

                const preface = document.createElement('div');
                preface.className = 'biography-preface';
                preface.textContent = bio.preface || 'å…¶äººåˆå…¥æå›ï¼Œæ€€å¿—è€Œè¡Œã€‚';

                const body = document.createElement('div');
                body.className = 'biography-body';
                const bodyLines = (bio.body || '').split(/\n+/).filter(Boolean);
                if (bodyLines.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = 'å­¦é€”æœ‰èµ·æœ‰ä¼ï¼Œç»ˆå½’æœ‰å¾—ã€‚';
                    body.appendChild(p);
                } else {
                    bodyLines.forEach((line) => {
                        const p = document.createElement('p');
                        p.textContent = line;
                        body.appendChild(p);
                    });
                }

                const epilogue = document.createElement('div');
                epilogue.className = 'biography-epilogue';
                const epilogueTitle = document.createElement('div');
                epilogueTitle.className = 'biography-epilogue-title';
                epilogueTitle.textContent = bio.epilogue_title || 'å¤ªå²å…¬æ›°';
                const epilogueText = document.createElement('div');
                epilogueText.className = 'biography-epilogue-text';
                epilogueText.textContent = bio.epilogue || 'å¾—å¤±ä¹‹é—´ï¼Œæœ€è´µåœ¨è‡ªçŸ¥ã€‚';
                epilogue.appendChild(epilogueTitle);
                epilogue.appendChild(epilogueText);

                const signature = document.createElement('div');
                signature.className = 'biography-signature';
                signature.textContent = bio.signature || 'å¤ªå²å…¬æ›°';

                biographyTarget.appendChild(title);
                biographyTarget.appendChild(quote);
                biographyTarget.appendChild(dividerTop);
                biographyTarget.appendChild(preface);
                biographyTarget.appendChild(body);
                biographyTarget.appendChild(epilogue);
                biographyTarget.appendChild(signature);
            };

            const renderFallbackBiography = () => {
                renderBiography({
                    title: 'è®¤æ¸…ç°å®',
                    quote: 'â€œçŸ¥æ­¢ä¸æ®†ï¼Œå–„è«å¤§ç„‰ã€‚â€',
                    preface: 'å…¶äººå…¥å­¦ä¹‹åˆï¼ŒæŠ±å¿—è€Œè¡Œï¼Œäº¦çŸ¥è¿›é€€ã€‚',
                    body: 'å››å¹´ä¹‹ä¸­ï¼Œæˆ–å‹¤æˆ–æƒ°ï¼Œæˆ–æ˜æˆ–è¿·ï¼Œç»ˆèƒ½å–èˆæœ‰åº¦ã€‚\nåŠŸåæœªå¿…å°½å¾—ï¼Œç„¶å¿ƒå¿—æ—¢å®šï¼Œäº¦è¶³è‡ªç«‹ã€‚',
                    epilogue_title: 'å¤ªå²å…¬æ›°',
                    epilogue: 'å¾—å¤±ä¹‹é—´ï¼Œè´µåœ¨è‡ªçŸ¥ï¼›çŸ¥æ­¢è€Œè¡Œï¼Œæ–¹èƒ½ä¹…è¿œã€‚',
                    signature: 'å¤ªå²å…¬æ›°'
                });
            };

            try {
                if (window.AIModule && typeof AIModule.fetchEndingBiography === 'function' && parsedState && parsedState.name) {
                    console.log('æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–å°ä¼ ...', {
                        playerName: parsedState.name,
                        college: parsedState.college,
                        background: parsedState.background,
                        discipline: parsedState.discipline,
                        totalMonths: parsedState.totalMonths,
                        gpa: parsedState.gpa,
                        social: parsedState.social,
                        san: parsedState.san
                    });
                    const bio = await AIModule.fetchEndingBiography({
                        endingType,
                        endingTitle: ending.title,
                        endingDesc: ending.desc,
                        state: parsedState
                    });
                    if (bio && bio.body) {
                        renderBiography(bio);
                    } else {
                        console.warn('å°ä¼ æ•°æ®ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤æ–‡æ¡ˆ');
                        renderFallbackBiography();
                    }
                } else {
                    console.warn('AIæ¨¡å—ä¸å¯ç”¨æˆ–ç¼ºå°‘ç©å®¶åå­—');
                    renderFallbackBiography();
                }
            } catch (error) {
                console.warn('å°ä¼ ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ–‡æ¡ˆ', error);
                renderFallbackBiography();
            }

            // è§£é”æ¯•ä¸šæˆå°±
            if (endingType !== 'dropout') {
                AchievementSystem.unlock('graduation');
            }

            // æŒ‰é’®äº‹ä»¶
            document.getElementById('btn-restart').addEventListener('click', function() {
                localStorage.removeItem('xjtu_game_state');
                window.location.href = 'index.html';
            });

            document.getElementById('btn-view-achievements').addEventListener('click', function() {
                window.location.href = 'achievements.html';
            });
        });
    </script>
</body>
</html>
